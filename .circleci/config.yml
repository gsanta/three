version: 2.1

jobs:
  build_cpp:
    working_directory: ~/engine
    machine:
      image: ubuntu-2004:current
    resource_class: large
    steps:
      - checkout
      - run:
          name: Compile cpp with emscripten
          command: |
            set -x
            cd engine
            docker-compose run --rm compiler; echo $?
            cd Web
            cd bin
            pwd
      - persist_to_workspace:
          root: engine/Web/bin
          paths:
            - sparky.js
            - sparky.wasm
  build_client:
    working_directory: ~/client
    docker:
      - image: cimg/node:16.15.0
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: cd client && npm i
      - run:
          name: Build
          command: cd client && npm run build
  assemble_frontend:
    docker:
      - image: cimg/node:16.15.0
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "dc:92:64:8c:74:1a:84:49:fd:90:ba:7c:5a:0a:50:ec"
      - attach_workspace:
          at: /tmp/engine/Web/bin
      - run:
          name: Copy files
          command: |
            mkdir -p client/static
            cp -r /tmp/engine/Web/bin/* client/static
            git config user.email "santagergely90@gmail.com"
            git config user.name "CircleCI Job"
            git add -A
            git commit --allow-empty -am "Automatic commit from CircleCI [skip ci]"
            git push origin master
  deploy:
    docker:
      - image: cimg/node:16.15.0
    steps:
      - run:
          name: Trigger deploy
          command: |
            curl $RENDER_DEPLOY_HOOK_FRONTEND
workflows:
  build-test-and-deploy:
    jobs:
      - build_cpp
      - build_client
      - assemble_frontend:
          requires:
            - build_cpp
            - build_client
      - deploy:
          requires:
            - "assemble_frontend"
          filters:
            branches:
              only: /^master/
