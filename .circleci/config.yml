version: 2.1

orbs:
  ruby: circleci/ruby@1.1.0
  node: circleci/node@2

jobs:
  build_cpp:
    working_directory: ~/engine
    docker:
      - image: cimg/node:16.15.0
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Compile cpp with emscripten
          command: |
            set -x
            cd engine
            docker-compose up
  build_client:
    working_directory: ~/client
    docker:
      - image: cimg/node:16.15.0
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: cd client && npm i
      - run:
          name: Build
          command: npm run build
  assemble_frontend:
    docker:
      - image: cimg/node:16.15.0
    steps:
      - checkout
      - run:
          name: Copy files
          command: cp ./engine/Web/bin/{sparky.js,sparky.wasm} ./client/dist
      - run:
          name: Check
          command: cd client/dist && ls -la
  # deploy-frontend:
  #   machine:
  #     enabled: true
  #   # working_directory: ~/circleci-demo-workflows
  #   environment:
  #     HEROKU_APP: "cryptic-chamber-32314"
  #   steps:
  #     - checkout
  #     - run:
  #         name: Setup Heroku
  #         command: bash .circleci/setup-heroku.sh

  #     - run:
  #         command: |
  #           git push heroku master
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-test-and-deploy: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build_cpp
      - build_client
      - assemble_frontend:
          requires:
            - build_cpp
            - build_client
      # - build
      # - test_backend:
      #     name: "Test Backend"
      # - test_frontend:
      #     name: "Test Frontend"
      # - rubocop/rubocop:
      #     name: "Lint Backend"
      # # - codecov/upload:
      # #     requires:
      # #       # - build
      # #       - 'Test Backend'
      # #       - 'Test Frontend'
      # # - rubocop/rubocop:
      # #     version: 0.71.0
      # - deploy-backend:
      #     name: "Deploy Backend"
      #     requires:
      #       # - build
      #       - "Test Backend"
      #       - "Test Frontend"
      #       - "Lint Backend"
      # - deploy-frontend:
      #     name: "Deploy Frontend"
      #     requires:
      #       - "Deploy Backend"
